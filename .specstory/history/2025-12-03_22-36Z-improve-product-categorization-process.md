<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 00868365-8e5d-4067-9ac9-9153f4520a25 (2025-12-03 22:36Z) -->

# Improve product categorization process (2025-12-03 22:36Z)

_**User (2025-12-03 16:38Z)**_

we need an easy way to classify specific product to categories. In the products catalog (/admin/products) make it easy to select the category and if desired sub category, and the master item parent for a product

---

_**Agent (model gemini-3-pro-preview, mode Agent)**_

<think><details><summary>Thought Process</summary>
**Exploring Product Classification**

I'm currently focused on the product classification workflow in the admin panel. My immediate task involves designing user-friendly interfaces for category, subcategory, and "master item parent" selection. I'm prioritizing ease of use and efficient data entry for the `/admin/products` page.


**Reviewing Implementation Details**

I've begun examining the `src/app/admin/products` directory to understand the existing structure. My focus is now on `src/app/admin/products/page.tsx` and its associated components, to understand how the current product management UI is implemented. Also reviewing the database schema in `supabase_schema.sql` to learn about the product, category, subcategory and master item relationships. I will then devise dropdown or combobox controls.


**Listing Product Directory Contents**

I'm now cataloging the files within the `src/app/admin/products` directory. After that, I intend to examine the schema definition in `supabase_schema.sql` to map the category, subcategory, and master item relationships. This data will inform the design of appropriate UI controls like dropdowns or comboboxes within the product editing interface, likely within `page.client.tsx`.


</details></think>

---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_dir** • Listed directory undefined • **0** results</summary>
        
No results found
</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: supabase_schema.sql</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Examining the Schema Structure**

I'm now digging into the `supabase_schema.sql` file. Initial observations show the presence of `categories`, which establishes a hierarchical structure. I'm focusing on the fields of `categories` and `master_items` for now. I'll need to figure out how `category_id` in `master_items` interacts with `parent_id` in `categories`, and how that influences data retrieval and filtering.


**Assessing Data Relationships**

I'm zeroing in on the data structure's hierarchical nature. I can see the table relationships and how they work together, with `specific_products` ultimately relying on `master_items`, which, in turn, relies on `categories`. I've begun to understand the filtering process: category selection impacts master item selection. Now, I will start to investigate the implementation specifics.


</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/app/admin/products/page.client.tsx</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Examining Implementations**

I'm currently reviewing the existing `ProductsClient` implementation, specifically focusing on the modal's handling of category, subcategory, and master item selection. Initial assessment reveals existing logic that I need to dissect. I'm keen to understand how this functionality is structured and how it interacts with other components within the admin area.


**Evaluating the UI Components**

I'm now carefully examining the UI components used within the categorization section of the `ProductsClient` component. I'm taking a close look at the `SelectInput` implementation and the category/subcategory selection logic to understand how the user interacts with this functionality. It seems like the approach resets the subcategory on category change, which is an important detail to keep in mind.


**Understanding the Existing Structure**

I'm presently focused on the categorization section, pinpointing the category, subcategory, and master item selection implemented within the `/admin/products` area. The code reveals the use of `SelectInput` components, with a key detail being the subcategory reset on a category change. The master item selection is also present, and is being filtered, implying it's data driven.


**Delving Deeper into Logic**

I'm now focusing on the `filteredMasterItems` logic within the `ProductsClient` component. It appears to filter based on `selectedSubCategory` or `selectedCategory`. My next step is to test this filtering to ensure it functions as intended and meets the requirements outlined in the user's query. I'll need to confirm that it accurately reflects the user's intent to select the category, subcategory, and master item for a product.


**Refining Filtering Expectations**

I'm now deeply analyzing the filtering logic for master items. It uses `selectedSubCategory` or `selectedCategory` to determine the filter. Currently, if a subcategory is *not* selected, master items are filtered by the root category only. This behavior might not be what the user expects; they may want to see items from subcategories when only the root is selected. The existing implementation *does* filter correctly if the subcategory is selected, matching the user's explicit requirement. I need to verify what the actual goal is: display items only in root category, all items in the root category *and* its subcategories, or a user experience issue.


**Verifying Filtered Results**

I'm now focusing on the implications of the filtering implemented on the `masterItems`. Specifically, I need to test the filtering using different combinations of category and subcategory selections, to fully understand if the user's intent is met. I want to confirm that if only the root category is selected, then master items belonging to that root are displayed correctly. And conversely, if a subcategory is selected, master items associated with that specific subcategory will also display correctly.


**Reflecting on Requirements**

I'm now revisiting the user's requirements and the current implementation to assess the gap. The existing code handles category, subcategory, and master item selection within the product editing modal. However, I'm questioning whether the user wants this functionality in the list view, or if the current modal implementation isn't working as intended. The "for a product" phrasing strongly suggests a focus on the edit/create flow, where I'm currently focused.


**Evaluating the Filtering Logic**

Now, I'm considering modifying the `filteredMasterItems` filter. The existing code correctly filters by subcategory, and by the root category. I think the user might expect master items from subcategories to be displayed when only the parent category is selected. I am now exploring how to modify `filteredMasterItems` to accommodate that behavior using a `categories` prop to determine subcategories.


**Reviewing Proposed Improvements**

I'm now revisiting the suggested alterations to `filteredMasterItems` and the `SelectInput` component, ensuring the changes align with the user's intent to simplify master item selection within the product editing modal. The aim is to ensure users can easily find and associate master items, even when the subcategory isn't explicitly selected. I need to make sure the proposed change doesn't introduce any regressions.


**Refining the Implementation**

Now I'm focusing on the changes made to the `filteredMasterItems` filter and considering the implications for the user experience within the product editing modal. The modifications were designed to include master items from subcategories when only a parent category is selected. I need to make sure the dropdown list displays the subcategory to assist the user. It is very likely this will resolve the user's issue.


**Implementing Filtered Master Items**

I'm now implementing the `filteredMasterItems` changes, which are intended to include master items from subcategories when the parent category is selected, while focusing on the impact on the user experience. I'm exploring the nuances of the display options to make sure it will be easy to understand by the user, and to resolve the user's issue.


**Modifying Filter Implementation**

I'm now revising the `filteredMasterItems` function to include master items from subcategories when the parent category is selected. This change should make it easier for the user, in line with the user's intent. The goal is to improve the user experience within the product editing modal. I'm focusing on ensuring the category display is accurate in the selection area.


**Verifying the Solution**

I'm now carefully implementing the proposed changes to the `filteredMasterItems` function. Alongside, I'm adjusting the display options within the `SelectInput` component to show the subcategory names when necessary. This should ensure the user experience is significantly enhanced within the product editing modal.


</details></think>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [-] Update filteredMasterItems logic to include subcategory items
- [ ] Update Master Item dropdown to show subcategory name if applicable

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Beginning Product Edit**

I'm starting to modify the product page client-side file. My initial plan is to use search and replace to update the `filteredMasterItems` definition. After that, I'll tackle the JSX rendering of the options.


**Implementing Targeted Edits**

I'm deep in the `src/app/admin/products/page.client.tsx` file now. I've decided against a full file rewrite, sticking with `search_replace` for safety. My next move is to replace the `filteredMasterItems` definition, taking care to incorporate the dependencies on `masterItems`, `selectedCategory`, `selectedSubCategory`, and `categories`.  After that's locked, I will proceed with the update to the JSX block.


**Analyzing Code Structure**

I'm now focusing on a complete update of the `filteredMasterItems` definition, taking into account its dependencies on `masterItems`, `selectedCategory`, `selectedSubCategory`, and `categories`. I've outlined the logic flow, noting that the `category_id` from the `masterItems` links them to a specific category. After that, I will tackle the JSX rendering of the Master Item select. I think it is important to include a default option with dynamic text to provide better user guidance.


</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: src/app/admin/products/page.client.tsx</summary>

**Chunk 1**
Lines added: 16, lines removed: 7

```diff
@@ -102,12 +102,21 @@
  
    // Filter Master Items based on selection
-   // If subcategory selected -&gt; match subcategory
-   // Else if category selected -&gt; match category OR any of its subcategories (if master items are assigned to subcats)
-   // Actually, master_items are linked to a specific category_id.
    const filteredMasterItems = useMemo(() =&gt; {
-       const targetCatId = selectedSubCategory || selectedCategory;
-       if (!targetCatId) return [];
-       return masterItems.filter(m =&gt; m.category_id === targetCatId);
-   }, [masterItems, selectedCategory, selectedSubCategory]);
+       if (selectedSubCategory) {
+           return masterItems.filter(m =&gt; m.category_id === selectedSubCategory);
+       }
+       
+       if (selectedCategory) {
+            const childCategoryIds = categories
+                .filter(c =&gt; c.parent_id === selectedCategory)
+                .map(c =&gt; c.id);
+            
+            const relevantIds = new Set([selectedCategory, ...childCategoryIds]);
+            
+            return masterItems.filter(m =&gt; relevantIds.has(m.category_id));
+       }
+       
+       return [];
+   }, [masterItems, selectedCategory, selectedSubCategory, categories]);
  
    // Initialize form state when opening modal
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
**Updating the JSX**

\n\n

I'm currently working on incorporating the subcategory name into the dropdown display. My primary focus is on modifying the JSX structure to render the name correctly. I must be cautious when utilizing the `map` function within the JSX to avoid any potential rendering issues.


**Applying the Mapping Logic**

\n\n

The JSX is now updated! I've successfully implemented the more intricate mapping logic. I'm dynamically generating the dropdown labels to include the subcategory names when appropriate. This should enhance the user experience. The key was careful handling of the `map` function and conditional label assignments to ensure the dropdown displays correctly.


</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: src/app/admin/products/page.client.tsx</summary>

**Chunk 1**
Lines added: 9, lines removed: 1

```diff
@@ -362,5 +362,13 @@
                                                   (filteredMasterItems.length === 0 ? 'No Master Items Found' : 'Select Master Item...')}
                                              &lt;/option&gt;
-                                             {filteredMasterItems.map(m =&gt; &lt;option key={m.id} value={m.id}&gt;{m.name}&lt;/option&gt;)}
+                                             {filteredMasterItems.map(m =&gt; {
+                                                 let label = m.name;
+                                                 // If showing items from parent category (no subcategory selected), indicate subcategory
+                                                 if (!selectedSubCategory &amp;&amp; selectedCategory &amp;&amp; m.category_id !== selectedCategory) {
+                                                     const sub = categories.find(c =&gt; c.id === m.category_id);
+                                                     if (sub) label = &#96;${m.name} (${sub.name})&#96;;
+                                                 }
+                                                 return &lt;option key={m.id} value={m.id}&gt;{label}&lt;/option&gt;;
+                                             })}
                                          &lt;/SelectInput&gt;
                                      &lt;/InputGroup&gt;
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
**Evaluating Feature Implementation**

I've successfully added the functionality to classify products, enabling Master Item selection from a parent category. The subcategory will be indicated in the dropdown, as requested. Currently, I am about to check the related logic to ensure it's functioning as expected, and that it doesn't break any dependencies.


**Refining Category Selection Logic**

I've confirmed the "Alert" logic functions as intended, providing clear feedback when no master items are found. The selection behavior aligns with the requirements, allowing for broad or specific category choices. Time to move on to edge-case testing of the feature, particularly focusing on how parent and child relationships interact during selection.


**Validating UX Considerations**

I've confirmed the "Alert" logic functions as intended, even with the expanded category selections. Both the broad category and specific subcategory filters behave as expected, and the UI correctly reflects these choices. I'm now verifying the subcategory selection resets and pre-selections to ensure that user experience remains intuitive and aligned with the requirements. Next up is testing the filtering logic of sub categories.


**Analyzing UI and Edge Cases**

I've reviewed the "Alert" logic; it remains valid, correctly indicating when master items are unavailable. My testing shows the category and subcategory selection interactions are as designed, including the required resets. I've also identified and resolved edge cases in subcategory and category selection, and refined the behavior of the mixed lists to prevent user confusion. The classification by selecting a Master Item will work as expected.


**Evaluating Item-Subcategory Interaction**

I've verified the "Alert" logic functions correctly, and that the category/subcategory filters align with the user intent. I'm now weighing whether to automatically populate the subcategory when a Master Item is chosen from the mixed list. I'm leaning toward leaving the subcategory selection untouched for now, since the dropdowns are just filters. This is due to the uncontrolled nature of the inputs.


**Enhancing Item-Subcategory Handling**

I've verified the "Alert" logic functions correctly. Now, I'm integrating an `onChange` handler for the Master Item selection. It will automatically populate the subcategory when a Master Item is chosen. This will improve user experience and more accurately reflect the product's classification, aligning with the "make it easy" requirement. The implementation should be straightforward.


**Evaluating Automatic Subcategory Select**

I've verified the "Alert" logic functions correctly. I'm now weighing whether to automatically populate the subcategory when a Master Item is chosen from the mixed list. I'm leaning toward leaving the subcategory selection untouched for now, since the dropdowns are just filters. This is due to the uncontrolled nature of the inputs.


**Reflecting On Implementation Choices**

I've verified the "Alert" logic functions correctly. I'm now weighing whether to automatically populate the subcategory when a Master Item is chosen from the mixed list. I'm leaning toward leaving the subcategory selection untouched for now, since the dropdowns are just filters. This is due to the uncontrolled nature of the inputs.


</details></think>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 1 file</summary>
      
Lint paths:

- `src/app/admin/products/page.client.tsx`

Lint results


**No lint errors found**
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Confirming Additional Criteria**

I'm now satisfied I've addressed the ease of category, sub-category, and parent item selection for a product. However, I should probably also verify if there are any other unaddressed requirements.


**Investigating Further Needs**

I'm now thinking about how to check the remaining requirements. I've already tackled the core selection process, but now I'm shifting to how to test the UI changes. It looks like I need to use playwright MCP to test UI changes, but I need to figure out how to start the dev server, which will be the first step. I will check the `package.json` file.


</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: package.json</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Initiating the Workflow**

I'm starting by executing `npm run dev` to get the application running. Next, I'll confirm that port 3000 is available. After that, I intend to navigate to the `/admin/products` route. Since this is likely a protected route, I'll need to figure out how to handle the Supabase Auth, potentially logging in or bypassing authentication. The challenge lies in testing this without a proper session.


**Analyzing the Code**

I've reviewed the updated React logic, specifically in `page.client.tsx`. I've re-examined the `filteredMasterItems` implementation. The refactor addresses the previous limitations. It handles both category and subcategory selections, ensuring correct filtering. I'm now confident in the change and ready to test it.


**Verifying Implementation Details**

I'm now focusing on the implementation details. I'll check that the `categories` prop is being passed correctly to the `ProductsClient` component. This is in `src/app/admin/products/page.tsx`. Additionally, I'll perform a final mental walk-through of the `filteredMasterItems` logic to ensure everything is perfect.


</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/app/admin/products/page.tsx</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Completing The Task**

I've successfully finalized the implementation. The focus was on improving the selection process, making it both simpler and more descriptive. All remaining TODO items have been addressed. The work is now complete.


</details></think>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Update filteredMasterItems logic to include subcategory items
- [x] Update Master Item dropdown to show subcategory name if applicable

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Anticipating the Response**

I'm ready to proceed. I've considered the prompt and am prepared to formulate a concise response based on the given parameters. My focus is on delivering a clear and compliant answer.


</details></think>

---

I have improved the product classification workflow in the `/admin/products` page. Now, when you select a main Category, the "Master Item" dropdown will automatically include items from both the category itself and all its subcategories, instead of requiring you to select the specific subcategory first.

The changes include:
1.  **Smarter Filtering**: If only a Category is selected, the Master Item list shows all valid options from that category's hierarchy.
2.  **Better Context**: When viewing a mixed list of items (from a parent category), items from subcategories now display their subcategory name (e.g., "Tent (Shelter)") so you know exactly what you are picking.
3.  **Flexible Flow**: You can still narrow down by selecting a Subcategory if you prefer, but it's no longer mandatory for finding deeply nested items.

These changes were made in `src/app/admin/products/page.client.tsx`.

---

_**User (2025-12-03 16:38Z)**_

We should have an easy way to add a new master item within the edit product form if one does not exist for the chosen category and subcategory. Add a "+" button to the right of the master item dropdown and popup a modal dialog to add the master item and when done, add it to the dropdown

---

_**Agent (model gemini-3-pro-preview, mode Agent)**_

<think><details><summary>Thought Process</summary>
**Adding Master Item Functionality**

I've been focusing on adding a "Master Item" creation feature to the "Edit Product" form. The plan is to allow direct creation from within the admin interface. I've successfully incorporated a dropdown for selecting the "Master Item". The dropdown now dynamically filters "Master Items" based on the product's category. Next step: implement the create "Master Item" modal.


**Designing Modal Integration**

I'm now sketching out the modal interface for creating new "Master Items" directly within the product editor. I'm focusing on the UI/UX, specifically the "+" button integration next to the dropdown. I'm considering best practices for a seamless user experience, including clear feedback and automatic dropdown updates after item creation. I'm also ensuring the modal form fields align perfectly with the "Master Item" data structure.


**Assessing Server Actions**

I'm now diving into the server-side action requirements. My immediate focus is determining the existence of a `createMasterItem` action within `src/app/admin/products/actions.ts`. If it's missing, I'll need to define it to handle the modal form submissions. This is a crucial step before I can proceed with the client-side implementation, specifically the modal and its interaction with the dropdown.


</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/app/admin/products/actions.ts</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Adding the Functionality**

I'm currently working on adding the `createMasterItem` function to the `actions.ts` file. It'll take `name` and `category_id` as inputs. It seems straightforward, but I need to make sure it integrates correctly with the existing codebase.


**Designing the Implementation**

I've sketched out the initial steps for the `createMasterItem` function. The plan is to start with the server-side action in `actions.ts`, accepting `name` and `category_id`. Then, I'll move on to the client-side form in `page.client.tsx`. I'll manage the modal state and the submission, anticipating that revalidating the path will refresh the `masterItems` prop, though I may consider a local state update for a smoother user experience.


**Initiating the Action**

Okay, the immediate task is to create the `createMasterItem` server action in `actions.ts`. I will need this action to accept `name` and `category_id` as inputs. Then, I'll move on to the `page.client.tsx` to integrate it with the UI. The action can return the created item, to enable an instant UI update.


</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: src/app/admin/products/actions.ts</summary>

**Chunk 1**
Lines added: 26, lines removed: undefined

```diff
@@ -157,3 +157,29 @@
      revalidatePath('/admin/products');
  }
+ 
+ export async function createMasterItem(formData: FormData) {
+     await checkAdmin();
+ 
+     const name = formData.get('name') as string;
+     const category_id = formData.get('category_id') as string;
+     const description = formData.get('description') as string;
+ 
+     if (!name || !category_id) throw new Error('Name and Category are required');
+ 
+     const { data, error } = await supabaseAdmin
+         .from('master_items')
+         .insert({
+             name,
+             category_id,
+             description,
+             status: 'active'
+         })
+         .select()
+         .single();
+ 
+     if (error) throw new Error(error.message);
+ 
+     revalidatePath('/admin/products');
+     return data;
+ }
  
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
**Analyzing the Next Steps**

I've decided to tackle the client-side updates next. My focus now is on `src/app/admin/products/page.client.tsx`. I'll start by bringing in `createMasterItem` from the actions. Then, I'll need to establish the necessary state variables, specifically `isMasterItemModalOpen` and `newMasterItemName`. It's a clear path forward now.


**Refining Implementation Strategy**

I'm deep in the implementation details now.  I'll start with the import and state variables in `src/app/admin/products/page.client.tsx`. Next comes the "+" button and modal UI. The modal needs Name and Description fields, and I'll pre-fill the Category ID. I'm leaning toward trusting the router refresh for smooth updates after the server action, given the client component nature. However, I might consider syncing props to state for instant visual feedback.


**Structuring Component Logic**

I'm now zeroing in on the UI implementation. I'll modify `src/app/admin/products/page.client.tsx` as planned, using a `useState` hook initialized with the `masterItems` prop. This will give me local control. Furthermore, I'll add a `useEffect` hook to update the local state when the prop changes, ensuring everything stays in sync.


**Executing the Implementation Plan**

I'm now fully immersed in the component's code.  I've decided on the initial strategy: I'm swapping the direct use of the `masterItems` prop with a state variable, `allMasterItems`, initialized from that prop. I'll also add a `useEffect` hook to keep the state synchronized with any prop updates, like those triggered by server revalidation. It's time to modify `src/app/admin/products/page.client.tsx`.


</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/app/admin/products/page.client.tsx</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [-] Update client file to include createMasterItem action import and UI updates
- [ ] Implement state management for new master item modal and list updates

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Initiating Product Page**

I've begun by refreshing the imports and state management in `src/app/admin/products/page.client.tsx`. I plan to integrate the UI modifications next. Specifically, the steps include importing `create MasterItem` and introducing a `useEffect` hook to synchronize the `masterItems` prop.


**Progressing on Product Page**

I'm now diving into the implementation phase. I've successfully imported `createMasterItem` and will introduce a `useEffect` hook to ensure the `masterItems` prop stays in sync. Next, I'll incorporate the `allMasterItems` and `isMasterItemModalOpen` states. After that, I will be modifying the use of `masterItems` to `allMasterItems` in `filteredMasterItems` and add the "+" button and the "New Master Item" modal. The `createMasterItem` export from actions has also been verified.


</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: src/app/admin/products/page.client.tsx</summary>

**Chunk 1**
Lines added: 2, lines removed: 2

```diff
@@ -1,7 +1,7 @@
  "use client";
  
- import { useState, useMemo } from "react";
+ import { useState, useMemo, useEffect } from "react";
  import { Plus, Trash2, Tags, ExternalLink, Search, Pencil, Upload, Image as ImageIcon, Package, DollarSign, Layers, AlertCircle, X, Save } from "lucide-react";
- import { createProduct, deleteProduct, updateProduct } from "./actions";
+ import { createProduct, deleteProduct, updateProduct, createMasterItem } from "./actions";
  import { createSupplier } from "../suppliers/actions";
  
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: src/app/admin/products/page.client.tsx</summary>

**Chunk 1**
Lines added: 9, lines removed: undefined

```diff
@@ -88,4 +88,13 @@
    const [selectedCategory, setSelectedCategory] = useState&lt;string&gt;("");
    const [selectedSubCategory, setSelectedSubCategory] = useState&lt;string&gt;("");
+   
+   // Master Items State
+   const [allMasterItems, setAllMasterItems] = useState(masterItems);
+   const [isMasterItemModalOpen, setIsMasterItemModalOpen] = useState(false);
+ 
+   // Sync props to state when server revalidates
+   useEffect(() =&gt; {
+       setAllMasterItems(masterItems);
+   }, [masterItems]);
    
    // Supplier State
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: src/app/admin/products/page.client.tsx</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -113,5 +113,5 @@
    const filteredMasterItems = useMemo(() =&gt; {
        if (selectedSubCategory) {
-           return masterItems.filter(m =&gt; m.category_id === selectedSubCategory);
+           return allMasterItems.filter(m =&gt; m.category_id === selectedSubCategory);
        }
        
```

**Chunk 2**
Lines added: 2, lines removed: 2

```diff
@@ -123,9 +123,9 @@
             const relevantIds = new Set([selectedCategory, ...childCategoryIds]);
             
-            return masterItems.filter(m =&gt; relevantIds.has(m.category_id));
+            return allMasterItems.filter(m =&gt; relevantIds.has(m.category_id));
        }
        
        return [];
-   }, [masterItems, selectedCategory, selectedSubCategory, categories]);
+   }, [allMasterItems, selectedCategory, selectedSubCategory, categories]);
  
    // Initialize form state when opening modal
```

**Chunk 3**
Lines added: 1, lines removed: 1

```diff
@@ -134,5 +134,5 @@
        
        // Reverse lookup category structure from master_item_id
-       const master = masterItems.find(m =&gt; m.id === product.master_item_id);
+       const master = allMasterItems.find(m =&gt; m.id === product.master_item_id);
        if (master) {
            const cat = categories.find(c =&gt; c.id === master.category_id);
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: src/app/admin/products/page.client.tsx</summary>

**Chunk 1**
Lines added: 32, lines removed: 20

```diff
@@ -361,24 +361,36 @@
  
                                      &lt;InputGroup label="3. Master Item (Type)" required&gt;
-                                         &lt;SelectInput 
-                                             name="master_item_id" 
-                                             defaultValue={editingProduct?.master_item_id} 
-                                             required
-                                             disabled={filteredMasterItems.length === 0}
-                                         &gt;
-                                             &lt;option value=""&gt;
-                                                 {(!selectedCategory) ? 'Select Category First' : 
-                                                  (filteredMasterItems.length === 0 ? 'No Master Items Found' : 'Select Master Item...')}
-                                             &lt;/option&gt;
-                                             {filteredMasterItems.map(m =&gt; {
-                                                 let label = m.name;
-                                                 // If showing items from parent category (no subcategory selected), indicate subcategory
-                                                 if (!selectedSubCategory &amp;&amp; selectedCategory &amp;&amp; m.category_id !== selectedCategory) {
-                                                     const sub = categories.find(c =&gt; c.id === m.category_id);
-                                                     if (sub) label = &#96;${m.name} (${sub.name})&#96;;
-                                                 }
-                                                 return &lt;option key={m.id} value={m.id}&gt;{label}&lt;/option&gt;;
-                                             })}
-                                         &lt;/SelectInput&gt;
+                                         &lt;div className="flex gap-2"&gt;
+                                             &lt;SelectInput 
+                                                 name="master_item_id" 
+                                                 defaultValue={editingProduct?.master_item_id} 
+                                                 required
+                                                 disabled={!selectedCategory}
+                                                 key={editingProduct?.master_item_id /* Force re-render when updating */}
+                                             &gt;
+                                                 &lt;option value=""&gt;
+                                                     {(!selectedCategory) ? 'Select Category First' : 
+                                                      (filteredMasterItems.length === 0 ? 'No Master Items Found' : 'Select Master Item...')}
+                                                 &lt;/option&gt;
+                                                 {filteredMasterItems.map(m =&gt; {
+                                                     let label = m.name;
+                                                     // If showing items from parent category (no subcategory selected), indicate subcategory
+                                                     if (!selectedSubCategory &amp;&amp; selectedCategory &amp;&amp; m.category_id !== selectedCategory) {
+                                                         const sub = categories.find(c =&gt; c.id === m.category_id);
+                                                         if (sub) label = &#96;${m.name} (${sub.name})&#96;;
+                                                     }
+                                                     return &lt;option key={m.id} value={m.id}&gt;{label}&lt;/option&gt;;
+                                                 })}
+                                             &lt;/SelectInput&gt;
+                                             &lt;button 
+                                                 type="button"
+                                                 disabled={!selectedCategory}
+                                                 onClick={() =&gt; setIsMasterItemModalOpen(true)}
+                                                 className="bg-gray-800 hover:bg-gray-700 text-white px-3 rounded-lg border border-gray-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
+                                                 title="Add New Master Item"
+                                             &gt;
+                                                 &lt;Plus className="w-4 h-4" /&gt;
+                                             &lt;/button&gt;
+                                         &lt;/div&gt;
                                      &lt;/InputGroup&gt;
                                  &lt;/div&gt;
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: src/app/admin/products/page.client.tsx</summary>

**Chunk 1**
Lines added: 48, lines removed: undefined

```diff
@@ -572,4 +572,52 @@
          &lt;/div&gt;
        )}
+ 
+       {/* New Master Item Modal */}
+       {isMasterItemModalOpen &amp;&amp; (
+         &lt;div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-[60]"&gt;
+             &lt;div className="bg-gray-900 border border-gray-800 rounded-2xl p-6 w-full max-w-md shadow-xl animate-in fade-in zoom-in-95"&gt;
+                 &lt;h2 className="text-xl font-bold text-white mb-1"&gt;Create New Master Item&lt;/h2&gt;
+                 &lt;p className="text-gray-400 text-sm mb-4"&gt;
+                     Adding to: &lt;span className="text-blue-400 font-mono"&gt;{
+                         categories.find(c =&gt; c.id === (selectedSubCategory || selectedCategory))?.name || 'Unknown Category'
+                     }&lt;/span&gt;
+                 &lt;/p&gt;
+ 
+                 &lt;form action={async (formData) =&gt; {
+                     try {
+                         const category_id = selectedSubCategory || selectedCategory;
+                         if (!category_id) throw new Error("No category selected");
+                         
+                         formData.append('category_id', category_id);
+                         const newItem = await createMasterItem(formData);
+                         
+                         if (newItem) {
+                             setAllMasterItems(prev =&gt; [...prev, newItem].sort((a, b) =&gt; a.name.localeCompare(b.name)));
+                             // Auto-select the new item by updating editingProduct
+                             setEditingProduct((prev: any) =&gt; ({ ...prev, master_item_id: newItem.id }));
+                         }
+                         setIsMasterItemModalOpen(false);
+                     } catch (e) {
+                         console.error(e);
+                         alert("Failed to create master item");
+                     }
+                 }} className="space-y-4"&gt;
+                     &lt;InputGroup label="Master Item Name" required&gt;
+                         &lt;TextInput name="name" placeholder="e.g. Ultralight Backpack" required autoFocus /&gt;
+                     &lt;/InputGroup&gt;
+                     &lt;InputGroup label="Description"&gt;
+                         &lt;TextArea name="description" placeholder="General description of this type of item..." style={{ minHeight: '80px' }} /&gt;
+                     &lt;/InputGroup&gt;
+                     
+                     &lt;div className="flex justify-end gap-3 pt-4"&gt;
+                         &lt;button type="button" onClick={() =&gt; setIsMasterItemModalOpen(false)} className="px-4 py-2 text-gray-400 hover:text-white"&gt;Cancel&lt;/button&gt;
+                         &lt;button type="submit" className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-medium"&gt;
+                             Create Item
+                         &lt;/button&gt;
+                     &lt;/div&gt;
+                 &lt;/form&gt;
+             &lt;/div&gt;
+         &lt;/div&gt;
+       )}
      &lt;/div&gt;
    );
```

</details>

</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 1 file</summary>
      
Lint paths:

- `src/app/admin/products/page.client.tsx`

Lint results

Lint errors for `src/app/admin/products/page.client.tsx`


| Message | Range | Severity |
|-------|-------|----------|
| 'Supplier' is declared but never used. | 21:11-21:19 | DIAGNOSTIC_SEVERITY_HINT |


</details>
</tool-use>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Update client file to include createMasterItem action import and UI updates
- [x] Implement state management for new master item modal and list updates

</details>
</tool-use>

---

I have added the functionality to create a new Master Item directly from the Edit Product form.

Key features added:
1.  **New "+" Button**: A button next to the "Master Item" dropdown that is enabled when a category is selected.
2.  **Quick Creation Modal**: A simple modal that allows you to enter a name and description for the new Master Item. It automatically links the item to the currently selected Category or Subcategory.
3.  **Instant Update**: Once created, the new item is immediately added to the list and automatically selected in the dropdown, so you can continue editing the product without interruption.

The implementation handles both the backend creation (via a new server action) and the frontend state updates for a seamless experience.

---

_**User (2025-12-03 16:38Z)**_

when showing the list of products (/admin/products)  they should be grouped by cateogires with headings and subheadings for sub-categories. Add a filter at the top (next to import and add product) to filter by category, supplier and price range. Also add up/down small triangles for sorting. 

---

_**Agent (model gemini-3-pro-preview, mode Agent)**_

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [-] Implement grouping of products by category and subcategory in the product list display.
- [ ] Add filter controls for category, supplier, and price range to the product list toolbar.
- [ ] Implement sorting logic with up/down triangle indicators for relevant columns.

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/app/admin/products/page.client.tsx</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: src/app/admin/products/page.client.tsx</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -2,5 +2,5 @@
  
  import { useState, useMemo, useEffect } from "react";
- import { Plus, Trash2, Tags, ExternalLink, Search, Pencil, Upload, Image as ImageIcon, Package, DollarSign, Layers, AlertCircle, X, Save } from "lucide-react";
+ import { Plus, Trash2, Tags, ExternalLink, Search, Pencil, Upload, Image as ImageIcon, Package, DollarSign, Layers, AlertCircle, X, Save, ChevronUp, ChevronDown, ChevronRight, Filter } from "lucide-react";
  import { createProduct, deleteProduct, updateProduct, createMasterItem } from "./actions";
  import { createSupplier } from "../suppliers/actions";
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: src/app/admin/products/page.client.tsx</summary>

**Chunk 1**
Lines added: 9, lines removed: undefined

```diff
@@ -85,4 +85,13 @@
    const [searchTerm, setSearchTerm] = useState("");
    
+   // Filtering State
+   const [filterCategory, setFilterCategory] = useState&lt;string&gt;("");
+   const [filterSupplier, setFilterSupplier] = useState&lt;string&gt;("");
+   const [filterPriceRange, setFilterPriceRange] = useState&lt;string&gt;(""); // "0-50", "50-100", "100+"
+   
+   // Sorting State
+   const [sortField, setSortField] = useState&lt;string&gt;("name");
+   const [sortDirection, setSortDirection] = useState&lt;'asc' | 'desc'&gt;("asc");
+ 
    // State for cascading dropdowns
    const [selectedCategory, setSelectedCategory] = useState&lt;string&gt;("");
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: src/app/admin/products/page.client.tsx</summary>

**Chunk 1**
Lines added: 644, lines removed: 464

```diff
@@ -168,467 +168,647 @@
    };
  
-   const filteredProducts = products.filter(p =&gt; {
-     const term = searchTerm.toLowerCase();
-     return (
-         (p.name &amp;&amp; p.name.toLowerCase().includes(term)) ||
-         (p.sku &amp;&amp; p.sku.toLowerCase().includes(term)) ||
-         (p.asin &amp;&amp; p.asin.toLowerCase().includes(term)) ||
-         (p.supplier?.name &amp;&amp; p.supplier.name.toLowerCase().includes(term))
-     );
-   });
+   // Sorting Helper
+   const handleSort = (field: string) =&gt; {
+       if (sortField === field) {
+           setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
+       } else {
+           setSortField(field);
+           setSortDirection('asc');
+       }
+   };
...
-   return (
-     &lt;div className="p-8 max-w-[1600px] mx-auto"&gt;
-       &lt;div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4"&gt;
-         &lt;div&gt;
-             &lt;h1 className="text-3xl font-bold text-white flex items-center gap-3"&gt;
-                 &lt;Tags className="w-8 h-8 text-blue-500" /&gt;
-                 Products Catalog
-             &lt;/h1&gt;
-             &lt;p className="text-gray-400 mt-1"&gt;Manage individual SKUs and link them to suppliers&lt;/p&gt;
-         &lt;/div&gt;
-         &lt;div className="flex gap-3 w-full md:w-auto"&gt;
-             &lt;div className="relative flex-1 md:w-64"&gt;
-                 &lt;Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500" /&gt;
-                 &lt;input 
-                     placeholder="Search products..." 
-                     className="w-full bg-gray-800 border border-gray-700 rounded-lg pl-10 pr-4 py-2 text-white focus:ring-2 focus:ring-blue-500 outline-none"
-                     value={searchTerm}
-                     onChange={(e) =&gt; setSearchTerm(e.target.value)}
-                 /&gt;
-             &lt;/div&gt;
-             &lt;a 
-                 href="/admin/import"
-                 className="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors whitespace-nowrap border border-gray-700"
-             &gt;
-                 &lt;Upload className="w-4 h-4" /&gt;
-                 Import
-             &lt;/a&gt;
-             &lt;button
-             onClick={openNewModal}
-             className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors whitespace-nowrap"
-             &gt;
-             &lt;Plus className="w-4 h-4" /&gt;
-             Add Product
-             &lt;/button&gt;
-         &lt;/div&gt;
-       &lt;/div&gt;
- 
-       &lt;div className="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden shadow-xl"&gt;
-         &lt;table className="w-full text-left text-sm text-gray-400"&gt;
-             &lt;thead className="bg-gray-950 text-gray-200 uppercase font-medium border-b border-gray-800"&gt;
-                 &lt;tr&gt;
-                     &lt;th className="px-6 py-4 w-[40%]"&gt;Product Details&lt;/th&gt;
-                     &lt;th className="px-6 py-4"&gt;Inventory&lt;/th&gt;
-                     &lt;th className="px-6 py-4"&gt;Price&lt;/th&gt;
-                     &lt;th className="px-6 py-4 text-right"&gt;Actions&lt;/th&gt;
-                 &lt;/tr&gt;
-             &lt;/thead&gt;
-             &lt;tbody className="divide-y divide-gray-800"&gt;
-                 {filteredProducts.map((product) =&gt; (
-                     &lt;tr key={product.id} className="hover:bg-gray-800/50 transition-colors group"&gt;
-                         &lt;td className="px-6 py-4"&gt;
-                             &lt;div className="flex gap-4"&gt;
-                                 {product.image_url &amp;&amp; (
-                                     &lt;img src={product.image_url} alt="" className="w-12 h-12 rounded bg-gray-800 object-cover border border-gray-700" /&gt;
-                                 )}
-                                 &lt;div&gt;
-                                     &lt;div className="font-medium text-white text-base"&gt;{product.name}&lt;/div&gt;
-                                     &lt;div className="text-xs text-gray-500 mt-1 font-mono flex items-center gap-2"&gt;
-                                         {product.sku || product.asin || 'No ID'}
-                                         &lt;span className="w-1 h-1 rounded-full bg-gray-600"&gt;&lt;/span&gt;
-                                         {product.master_item?.name}
-                                     &lt;/div&gt;
-                                 &lt;/div&gt;
-                             &lt;/div&gt;
-                         &lt;/td&gt;
-                         &lt;td className="px-6 py-4"&gt;
-                             &lt;div className="flex flex-col gap-1"&gt;
-                                 &lt;div className="text-white"&gt;{product.supplier?.name || 'Unknown Supplier'}&lt;/div&gt;
-                                 &lt;span className={&#96;inline-flex w-fit px-2 py-0.5 rounded text-[10px] font-bold tracking-wide uppercase ${
-                                     product.type === 'DROP_SHIP' 
-                                     ? 'bg-purple-500/10 text-purple-400 border border-purple-500/20' 
-                                     : 'bg-blue-500/10 text-blue-400 border border-blue-500/20'
-                                 }&#96;}&gt;
-                                     {product.type}
-                                 &lt;/span&gt;
-                             &lt;/div&gt;
-                         &lt;/td&gt;
-                         &lt;td className="px-6 py-4"&gt;
-                             &lt;div className="text-white font-mono text-lg"&gt;${product.price?.toFixed(2)}&lt;/div&gt;
-                         &lt;/td&gt;
-                         &lt;td className="px-6 py-4 text-right"&gt;
-                             &lt;div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity"&gt;
-                                 {product.product_url &amp;&amp; (
-                                     &lt;a href={product.product_url} target="_blank" className="text-gray-400 hover:text-blue-400 p-2 hover:bg-gray-800 rounded-lg transition-colors"&gt;
-                                         &lt;ExternalLink className="w-4 h-4" /&gt;
-                                     &lt;/a&gt;
-                                 )}
-                                 &lt;button 
-                                     onClick={() =&gt; openEditModal(product)}
-                                     className="text-gray-400 hover:text-white p-2 hover:bg-gray-800 rounded-lg transition-colors"
-                                 &gt;
-                                     &lt;Pencil className="w-4 h-4" /&gt;
-                                 &lt;/button&gt;
-                                 &lt;form action={async () =&gt; {
-                                     if(confirm('Delete this product?')) await deleteProduct(product.id);
-                                 }}&gt;
-                                     &lt;button className="text-gray-400 hover:text-red-400 p-2 hover:bg-red-500/10 rounded-lg transition-colors"&gt;
-                                         &lt;Trash2 className="w-4 h-4" /&gt;
-                                     &lt;/button&gt;
-                                 &lt;/form&gt;
-                             &lt;/div&gt;
-                         &lt;/td&gt;
-                     &lt;/tr&gt;
-                 ))}
-                 {filteredProducts.length === 0 &amp;&amp; (
-                     &lt;tr&gt;
-                         &lt;td colSpan={5} className="px-6 py-12 text-center text-gray-500"&gt;
-                             &lt;Package className="w-12 h-12 mx-auto mb-3 text-gray-700" /&gt;
-                             &lt;p&gt;No products found matching your search.&lt;/p&gt;
-                         &lt;/td&gt;
-                     &lt;/tr&gt;
-                 )}
-             &lt;/tbody&gt;
-         &lt;/table&gt;
-       &lt;/div&gt;
- 
-       {/* Edit Product Modal (Redesigned) */}
-       {isModalOpen &amp;&amp; (
-         &lt;div className="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 z-50"&gt;
-           &lt;div className="bg-[#0f1117] border border-gray-800 rounded-2xl w-full max-w-6xl h-[90vh] shadow-2xl flex flex-col overflow-hidden"&gt;
-             
-             {/* Header */}
-             &lt;div className="px-8 py-6 border-b border-gray-800 flex justify-between items-center bg-[#13161c]"&gt;
-                 &lt;div&gt;
-                     &lt;h2 className="text-xl font-bold text-white flex items-center gap-3"&gt;
-                         {editingProduct ? &lt;Pencil className="w-5 h-5 text-blue-500" /&gt; : &lt;Plus className="w-5 h-5 text-blue-500" /&gt;}
-                         {editingProduct ? 'Edit Product' : 'New Product'}
-                     &lt;/h2&gt;
-                     &lt;p className="text-gray-500 text-sm mt-1"&gt;Configure product details, pricing, and inventory settings.&lt;/p&gt;
-                 &lt;/div&gt;
-                 &lt;button onClick={() =&gt; setIsModalOpen(false)} className="text-gray-500 hover:text-white p-2 hover:bg-gray-800 rounded-lg transition-colors"&gt;
-                     &lt;X className="w-6 h-6" /&gt;
-                 &lt;/button&gt;
-             &lt;/div&gt;
- 
-             {/* Scrollable Form Content */}
-             &lt;div className="flex-1 overflow-y-auto"&gt;
-                 &lt;form id="product-form" action={async (formData) =&gt; {
-                     if (editingProduct) {
-                         formData.append('id', editingProduct.id);
-                         await updateProduct(formData);
-                     } else {
-                         await createProduct(formData);
-                     }
-                     setIsModalOpen(false);
-                     setEditingProduct(null);
-                 }}&gt;
-                     &lt;div className="grid grid-cols-12 gap-0 min-h-full"&gt;
-                         
-                         {/* LEFT COLUMN: Main Content (Width 8/12) */}
-                         &lt;div className="col-span-12 lg:col-span-8 p-8 border-r border-gray-800 space-y-8"&gt;
-                             
-                             {/* Identity Section */}
-                             &lt;section&gt;
-                                 &lt;SectionTitle icon={Package}&gt;Product Identity&lt;/SectionTitle&gt;
-                                 &lt;InputGroup label="Product Name" required&gt;
-                                     &lt;TextInput name="name" defaultValue={editingProduct?.name} placeholder="e.g. Sawyer Squeeze Water Filter" required /&gt;
-                                 &lt;/InputGroup&gt;
-                                 &lt;InputGroup label="Description"&gt;
-                                     &lt;TextArea name="description" defaultValue={editingProduct?.description} placeholder="Detailed product description, features, and specs..." /&gt;
-                                 &lt;/InputGroup&gt;
-                             &lt;/section&gt;
- 
-                             {/* Categorization Section */}
-                             &lt;section&gt;
-                                 &lt;SectionTitle icon={Layers}&gt;Categorization&lt;/SectionTitle&gt;
-                                 &lt;div className="grid grid-cols-1 md:grid-cols-3 gap-4 bg-gray-900/30 p-4 rounded-xl border border-gray-800/50"&gt;
-                                     &lt;InputGroup label="1. Category"&gt;
-                                         &lt;SelectInput 
-                                             value={selectedCategory} 
-                                             onChange={e =&gt; {
-                                                 setSelectedCategory(e.target.value);
-                                                 setSelectedSubCategory(""); // Reset subcat
-                                             }}
-                                         &gt;
-                                             &lt;option value=""&gt;Select Category...&lt;/option&gt;
-                                             {rootCategories.map(c =&gt; &lt;option key={c.id} value={c.id}&gt;{c.name}&lt;/option&gt;)}
-                                         &lt;/SelectInput&gt;
-                                     &lt;/InputGroup&gt;
-                                     
-                                     &lt;InputGroup label="2. Subcategory"&gt;
-                                         &lt;SelectInput 
-                                             value={selectedSubCategory}
-                                             onChange={e =&gt; setSelectedSubCategory(e.target.value)}
-                                             disabled={!selectedCategory || subCategories.length === 0}
-                                         &gt;
-                                             &lt;option value=""&gt;{subCategories.length === 0 ? 'No Subcategories' : 'Select Subcategory...'}&lt;/option&gt;
-                                             {subCategories.map(c =&gt; &lt;option key={c.id} value={c.id}&gt;{c.name}&lt;/option&gt;)}
-                                         &lt;/SelectInput&gt;
-                                     &lt;/InputGroup&gt;
- 
-                                     &lt;InputGroup label="3. Master Item (Type)" required&gt;
-                                         &lt;div className="flex gap-2"&gt;
-                                             &lt;SelectInput 
-                                                 name="master_item_id" 
-                                                 defaultValue={editingProduct?.master_item_id} 
-                                                 required
-                                                 disabled={!selectedCategory}
-                                                 key={editingProduct?.master_item_id /* Force re-render when updating */}
-                                             &gt;
-                                                 &lt;option value=""&gt;
-                                                     {(!selectedCategory) ? 'Select Category First' : 
-                                                      (filteredMasterItems.length === 0 ? 'No Master Items Found' : 'Select Master Item...')}
-                                                 &lt;/option&gt;
-                                                 {filteredMasterItems.map(m =&gt; {
-                                                     let label = m.name;
-                                                     // If showing items from parent category (no subcategory selected), indicate subcategory
-                                                     if (!selectedSubCategory &amp;&amp; selectedCategory &amp;&amp; m.category_id !== selectedCategory) {
-                                                         const sub = categories.find(c =&gt; c.id === m.category_id);
-                                                         if (sub) label = &#96;${m.name} (${sub.name})&#96;;
-                                                     }
-                                                     return &lt;option key={m.id} value={m.id}&gt;{label}&lt;/option&gt;;
-                                                 })}
-                                             &lt;/SelectInput&gt;
-                                             &lt;button 
-                                                 type="button"
-                                                 disabled={!selectedCategory}
-                                                 onClick={() =&gt; setIsMasterItemModalOpen(true)}
-                                                 className="bg-gray-800 hover:bg-gray-700 text-white px-3 rounded-lg border border-gray-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
-                                                 title="Add New Master Item"
-                                             &gt;
-                                                 &lt;Plus className="w-4 h-4" /&gt;
-                                             &lt;/button&gt;
-                                         &lt;/div&gt;
-                                     &lt;/InputGroup&gt;
-                                 &lt;/div&gt;
-                                 {filteredMasterItems.length === 0 &amp;&amp; selectedCategory &amp;&amp; (
-                                     &lt;div className="mt-3 flex items-center gap-2 text-xs text-yellow-500 bg-yellow-500/10 p-3 rounded-lg"&gt;
-                                         &lt;AlertCircle className="w-4 h-4" /&gt;
-                                         No master items found in this category. Please add a Master Item first or check the category selection.
-                                     &lt;/div&gt;
-                                 )}
-                             &lt;/section&gt;
- 
-                             {/* Media Section */}
-                             &lt;section&gt;
-                                 &lt;SectionTitle icon={ImageIcon}&gt;Media &amp; Links&lt;/SectionTitle&gt;
-                                 &lt;div className="grid grid-cols-1 md:grid-cols-2 gap-6"&gt;
-                                     &lt;InputGroup label="Product Page URL" required&gt;
-                                         &lt;div className="flex gap-2"&gt;
-                                             &lt;TextInput name="product_url" type="url" defaultValue={editingProduct?.product_url} placeholder="https://amazon.com/..." required /&gt;
-                                             {editingProduct?.product_url &amp;&amp; (
-                                                 &lt;a href={editingProduct.product_url} target="_blank" className="p-2.5 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors"&gt;
-                                                     &lt;ExternalLink className="w-4 h-4 text-gray-400" /&gt;
-                                                 &lt;/a&gt;
-                                             )}
-                                         &lt;/div&gt;
-                                     &lt;/InputGroup&gt;
-                                     &lt;InputGroup label="Image URL"&gt;
-                                         &lt;TextInput name="image_url" type="url" defaultValue={editingProduct?.image_url} placeholder="https://..." /&gt;
-                                     &lt;/InputGroup&gt;
-                                 &lt;/div&gt;
-                                 {/* Image Preview */}
-                                 {(editingProduct?.image_url) &amp;&amp; (
-                                     &lt;div className="mt-4 w-32 h-32 bg-gray-900 rounded-lg border border-gray-800 flex items-center justify-center overflow-hidden relative group"&gt;
-                                         &lt;img src={editingProduct.image_url} alt="Preview" className="w-full h-full object-contain" /&gt;
-                                         &lt;div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity"&gt;
-                                             &lt;span className="text-xs text-white font-medium"&gt;Preview&lt;/span&gt;
-                                         &lt;/div&gt;
-                                     &lt;/div&gt;
-                                 )}
-                             &lt;/section&gt;
-                         &lt;/div&gt;
- 
-                         {/* RIGHT COLUMN: Sidebar (Width 4/12) */}
-                         &lt;div className="col-span-12 lg:col-span-4 bg-[#13161c] p-8 space-y-8 h-full"&gt;
-                             
-                             {/* Pricing Card */}
-                             &lt;div className="bg-gray-900/50 p-6 rounded-xl border border-gray-800"&gt;
-                                 &lt;SectionTitle icon={DollarSign}&gt;Pricing &amp; Type&lt;/SectionTitle&gt;
-                                 &lt;div className="space-y-4"&gt;
-                                     &lt;InputGroup label="Price ($)" required&gt;
-                                         &lt;TextInput name="price" type="number" step="0.01" defaultValue={editingProduct?.price} className="text-lg font-mono" required /&gt;
-                                     &lt;/InputGroup&gt;
-                                     &lt;InputGroup label="Fulfillment Type"&gt;
-                                         &lt;SelectInput name="type" defaultValue={editingProduct?.type || "AFFILIATE"}&gt;
-                                             &lt;option value="AFFILIATE"&gt;Affiliate Link (Referral)&lt;/option&gt;
-                                             &lt;option value="DROP_SHIP"&gt;Drop-Ship (Direct Sale)&lt;/option&gt;
-                                         &lt;/SelectInput&gt;
-                                     &lt;/InputGroup&gt;
-                                 &lt;/div&gt;
-                             &lt;/div&gt;
- 
-                             {/* Inventory Card */}
-                             &lt;div className="bg-gray-900/50 p-6 rounded-xl border border-gray-800"&gt;
-                                 &lt;SectionTitle icon={Package}&gt;Inventory &amp; Supplier&lt;/SectionTitle&gt;
-                                 &lt;div className="space-y-4"&gt;
-                                     &lt;InputGroup label="SKU / ASIN"&gt;
-                                         &lt;TextInput name="asin" defaultValue={editingProduct?.sku || editingProduct?.asin} placeholder="e.g. B005EHPVQW" /&gt;
-                                     &lt;/InputGroup&gt;
-                                     
-                                     &lt;InputGroup label="Supplier" required&gt;
-                                         &lt;div className="flex gap-2"&gt;
-                                             &lt;SelectInput 
-                                                 name="supplier_id" 
-                                                 defaultValue={editingProduct?.supplier_id}
-                                                 key={editingProduct?.supplier_id}
-                                                 required
-                                             &gt;
-                                                 &lt;option value=""&gt;Select Supplier...&lt;/option&gt;
-                                                 {suppliersList.map(s =&gt; (
-                                                     &lt;option key={s.id} value={s.id}&gt;{s.name}&lt;/option&gt;
-                                                 ))}
-                                             &lt;/SelectInput&gt;
-                                             &lt;button 
-                                                 type="button"
-                                                 onClick={() =&gt; setIsSupplierModalOpen(true)}
-                                                 className="bg-gray-800 hover:bg-gray-700 text-white px-3 rounded-lg border border-gray-700 transition-colors"
-                                                 title="Add New Supplier"
-                                             &gt;
-                                                 &lt;Plus className="w-4 h-4" /&gt;
-                                             &lt;/button&gt;
-                                         &lt;/div&gt;
-                                     &lt;/InputGroup&gt;
-                                 &lt;/div&gt;
-                             &lt;/div&gt;
- 
-                             {/* Metadata Card */}
-                             &lt;div className="bg-gray-900/50 p-6 rounded-xl border border-gray-800"&gt;
-                                 &lt;SectionTitle icon={Tags}&gt;Attributes&lt;/SectionTitle&gt;
-                                 &lt;div className="space-y-3"&gt;
-                                     &lt;InputGroup label="Brand"&gt;
-                                         &lt;TextInput name="meta_brand" defaultValue={editingProduct?.metadata?.brand} placeholder="Brand Name" /&gt;
-                                     &lt;/InputGroup&gt;
-                                     &lt;div className="grid grid-cols-2 gap-3"&gt;
-                                         &lt;InputGroup label="Weight (g)"&gt;
-                                             &lt;TextInput name="meta_weight_g" type="number" defaultValue={editingProduct?.metadata?.weight_g} /&gt;
-                                         &lt;/InputGroup&gt;
-                                         &lt;InputGroup label="Color"&gt;
-                                             &lt;TextInput name="meta_color" defaultValue={editingProduct?.metadata?.color} /&gt;
-                                         &lt;/InputGroup&gt;
-                                     &lt;/div&gt;
-                                 &lt;/div&gt;
-                             &lt;/div&gt;
- 
-                         &lt;/div&gt;
-                     &lt;/div&gt;
-                 &lt;/form&gt;
-             &lt;/div&gt;
- 
-             {/* Footer Actions */}
-             &lt;div className="px-8 py-4 border-t border-gray-800 bg-[#13161c] flex justify-between items-center"&gt;
-                 &lt;button type="button" onClick={() =&gt; { setIsModalOpen(false); setEditingProduct(null); }} className="px-6 py-2.5 text-gray-400 hover:text-white font-medium transition-colors"&gt;
-                     Cancel
-                 &lt;/button&gt;
-                 &lt;button 
-                     type="submit" 
-                     form="product-form"
-                     className="bg-blue-600 hover:bg-blue-500 text-white px-8 py-2.5 rounded-lg font-medium shadow-lg shadow-blue-900/20 flex items-center gap-2 transition-all hover:scale-105 active:scale-95"
-                 &gt;
-                     &lt;Save className="w-4 h-4" /&gt;
-                     {editingProduct ? 'Save Changes' : 'Create Product'}
-                 &lt;/button&gt;
-             &lt;/div&gt;
- 
-           &lt;/div&gt;
-         &lt;/div&gt;
-       )}
- 
-       {/* New Supplier Modal - kept simple */}
-       {isSupplierModalOpen &amp;&amp; (
-         &lt;div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-[60]"&gt;
-             &lt;div className="bg-gray-900 border border-gray-800 rounded-2xl p-6 w-full max-w-md shadow-xl animate-in fade-in zoom-in-95"&gt;
-                 &lt;h2 className="text-xl font-bold text-white mb-4"&gt;Create New Supplier&lt;/h2&gt;
-                 &lt;form action={async (formData) =&gt; {
-                     try {
-                         const newSupplier = await createSupplier(formData);
-                         if (newSupplier) {
-                             setSuppliersList(prev =&gt; [...prev, newSupplier].sort((a, b) =&gt; a.name.localeCompare(b.name)));
-                             // Auto-select the new supplier
-                             setEditingProduct((prev: any) =&gt; ({ ...prev, supplier_id: newSupplier.id }));
-                         }
-                         setIsSupplierModalOpen(false);
-                     } catch (e) {
-                         console.error(e);
-                         alert("Failed to create supplier");
-                     }
-                 }} className="space-y-4"&gt;
-                     &lt;InputGroup label="Name" required&gt;
-                         &lt;TextInput name="name" required /&gt;
-                     &lt;/InputGroup&gt;
-                     &lt;InputGroup label="Website URL"&gt;
-                         &lt;TextInput name="website_url" type="url" /&gt;
-                     &lt;/InputGroup&gt;
-                      &lt;InputGroup label="Fulfillment Type"&gt;
-                         &lt;SelectInput name="fulfillment_type"&gt;
-                             &lt;option value="AFFILIATE"&gt;Affiliate Partner&lt;/option&gt;
-                             &lt;option value="DROP_SHIP"&gt;Drop-Ship Vendor&lt;/option&gt;
-                         &lt;/SelectInput&gt;
-                     &lt;/InputGroup&gt;
-                     &lt;InputGroup label="Contact Email"&gt;
-                         &lt;TextInput name="contact_email" type="email" /&gt;
-                     &lt;/InputGroup&gt;
-                     &lt;div className="flex justify-end gap-3 pt-4"&gt;
-                         &lt;button type="button" onClick={() =&gt; setIsSupplierModalOpen(false)} className="px-4 py-2 text-gray-400 hover:text-white"&gt;Cancel&lt;/button&gt;
-                         &lt;button type="submit" className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-medium"&gt;
-                             Create Supplier
-                         &lt;/button&gt;
-                     &lt;/div&gt;
-                 &lt;/form&gt;
-             &lt;/div&gt;
-         &lt;/div&gt;
-       )}
- 
-       {/* New Master Item Modal */}
-       {isMasterItemModalOpen &amp;&amp; (
-         &lt;div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-[60]"&gt;
-             &lt;div className="bg-gray-900 border border-gray-800 rounded-2xl p-6 w-full max-w-md shadow-xl animate-in fade-in zoom-in-95"&gt;
-                 &lt;h2 className="text-xl font-bold text-white mb-1"&gt;Create New Master Item&lt;/h2&gt;
-                 &lt;p className="text-gray-400 text-sm mb-4"&gt;
-                     Adding to: &lt;span className="text-blue-400 font-mono"&gt;{
-                         categories.find(c =&gt; c.id === (selectedSubCategory || selectedCategory))?.name || 'Unknown Category'
-                     }&lt;/span&gt;
-                 &lt;/p&gt;
- 
-                 &lt;form action={async (formData) =&gt; {
-                     try {
-                         const category_id = selectedSubCategory || selectedCategory;
-                         if (!category_id) throw new Error("No category selected");
-                         
-                         formData.append('category_id', category_id);
-                         const newItem = await createMasterItem(formData);
-                         
-                         if (newItem) {
-                             setAllMasterItems(prev =&gt; [...prev, newItem].sort((a, b) =&gt; a.name.localeCompare(b.name)));
-                             // Auto-select the new item by updating editingProduct
-                             setEditingProduct((prev: any) =&gt; ({ ...prev, master_item_id: newItem.id }));
-                         }
-                         setIsMasterItemModalOpen(false);
-                     } catch (e) {
-                         console.error(e);
-                         alert("Failed to create master item");
-                     }
-                 }} className="space-y-4"&gt;
-                     &lt;InputGroup label="Master Item Name" required&gt;
-                         &lt;TextInput name="name" placeholder="e.g. Ultralight Backpack" required autoFocus /&gt;
-                     &lt;/InputGroup&gt;
-                     &lt;InputGroup label="Description"&gt;
-                         &lt;TextArea name="description" placeholder="General description of this type of item..." style={{ minHeight: '80px' }} /&gt;
-                     &lt;/InputGroup&gt;
-                     
-                     &lt;div className="flex justify-end gap-3 pt-4"&gt;
-                         &lt;button type="button" onClick={() =&gt; setIsMasterItemModalOpen(false)} className="px-4 py-2 text-gray-400 hover:text-white"&gt;Cancel&lt;/button&gt;
-                         &lt;button type="submit" className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-medium"&gt;
-                             Create Item
-                         &lt;/button&gt;
-                     &lt;/div&gt;
-                 &lt;/form&gt;
-             &lt;/div&gt;
-         &lt;/div&gt;
-       )}
-     &lt;/div&gt;
-   );
- }
- 
+   const SortIcon = ({ field }: { field: string }) =&gt; {
+       if (sortField !== field) return &lt;div className="w-4 h-4 opacity-0 group-hover/th:opacity-30 flex flex-col -space-y-1"&gt;&lt;ChevronUp className="w-3 h-3" /&gt;&lt;ChevronDown className="w-3 h-3" /&gt;&lt;/div&gt;;
+       return sortDirection === 'asc' ? &lt;ChevronUp className="w-4 h-4 text-blue-500" /&gt; : &lt;ChevronDown className="w-4 h-4 text-blue-500" /&gt;;
+   };
+ 
+   // Filter &amp; Sort Logic
+   const processedProducts = useMemo(() =&gt; {
+     let result = products.filter(p =&gt; {
+         // Text Search
+         const term = searchTerm.toLowerCase();
+         const matchesSearch = (
+             (p.name &amp;&amp; p.name.toLowerCase().includes(term)) ||
+             (p.sku &amp;&amp; p.sku.toLowerCase().includes(term)) ||
+             (p.asin &amp;&amp; p.asin.toLowerCase().includes(term)) ||
+             (p.supplier?.name &amp;&amp; p.supplier.name.toLowerCase().includes(term))
+         );
+ 
+         // Category Filter
+         let matchesCategory = true;
+         if (filterCategory) {
+             // Find all valid category IDs (selected cat + its subcats)
+             const subCatIds = categories.filter(c =&gt; c.parent_id === filterCategory).map(c =&gt; c.id);
+             const validCatIds = new Set([filterCategory, ...subCatIds]);
+             
+             // We need the category of the product's master item
+             const masterItem = masterItems.find(m =&gt; m.id === p.master_item_id);
+             matchesCategory = masterItem ? validCatIds.has(masterItem.category_id) : false;
+         }
+ 
+         // Supplier Filter
+         const matchesSupplier = filterSupplier ? p.supplier_id === filterSupplier : true;
+ 
+         // Price Filter
+         let matchesPrice = true;
+         if (filterPriceRange) {
+             const price = p.price || 0;
+             if (filterPriceRange === "0-50") matchesPrice = price &lt; 50;
+             else if (filterPriceRange === "50-100") matchesPrice = price &gt;= 50 &amp;&amp; price &lt;= 100;
+             else if (filterPriceRange === "100-500") matchesPrice = price &gt; 100 &amp;&amp; price &lt;= 500;
+             else if (filterPriceRange === "500+") matchesPrice = price &gt; 500;
+         }
+ 
+         return matchesSearch &amp;&amp; matchesCategory &amp;&amp; matchesSupplier &amp;&amp; matchesPrice;
+     });
+ 
+     // Sorting
+     result.sort((a, b) =&gt; {
+         let valA = a[sortField];
+         let valB = b[sortField];
+ 
+         // Handle nested fields
+         if (sortField === 'supplier') {
+             valA = a.supplier?.name || '';
+             valB = b.supplier?.name || '';
+         }
+         if (sortField === 'master_item') {
+             valA = a.master_item?.name || '';
+             valB = b.master_item?.name || '';
+         }
+ 
+         // Handle strings vs numbers
+         if (typeof valA === 'string') valA = valA.toLowerCase();
+         if (typeof valB === 'string') valB = valB.toLowerCase();
+ 
+         if (valA &lt; valB) return sortDirection === 'asc' ? -1 : 1;
+         if (valA &gt; valB) return sortDirection === 'asc' ? 1 : -1;
+         return 0;
+     });
+ 
+     return result;
+   }, [products, searchTerm, filterCategory, filterSupplier, filterPriceRange, sortField, sortDirection, masterItems, categories]);
+ 
+   // Grouping Logic (Only active if NOT searching/filtering heavily, or we can always group)
+   // Let's always group by Category -&gt; Subcategory -&gt; Products
+   const groupedProducts = useMemo(() =&gt; {
+       const groups: Record&lt;string, { category: Category, subGroups: Record&lt;string, { subCategory: Category | null, products: Product[] }&gt; }&gt; = {};
+       
+       // Helper to ensure structure exists
+       const ensureGroup = (catId: string, subCatId: string | null) =&gt; {
+           if (!groups[catId]) {
+               const cat = categories.find(c =&gt; c.id === catId);
+               if (!cat) return null; // Should not happen ideally
+               groups[catId] = { category: cat, subGroups: {} };
+           }
+           
+           const subKey = subCatId || 'root';
+           if (!groups[catId].subGroups[subKey]) {
+               const subCat = subCatId ? categories.find(c =&gt; c.id === subCatId) || null : null;
+               groups[catId].subGroups[subKey] = { subCategory: subCat, products: [] };
+           }
+           return groups[catId].subGroups[subKey];
+       };
+ 
+       processedProducts.forEach(p =&gt; {
+           const masterItem = masterItems.find(m =&gt; m.id === p.master_item_id);
+           if (!masterItem) return; // Orphaned product?
+ 
+           const cat = categories.find(c =&gt; c.id === masterItem.category_id);
+           if (!cat) return;
+ 
+           if (cat.parent_id) {
+               // It's a subcategory
+               const group = ensureGroup(cat.parent_id, cat.id);
+               if (group) group.products.push(p);
+           } else {
+               // It's a root category
+               const group = ensureGroup(cat.id, null);
+               if (group) group.products.push(p);
+           }
+       });
+ 
+       return groups;
+   }, [processedProducts, masterItems, categories]);
+ 
+ 
+   return (
+     &lt;div className="p-8 max-w-[1600px] mx-auto"&gt;
+       &lt;div className="flex flex-col gap-6 mb-8"&gt;
+         {/* Top Header */}
+         &lt;div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4"&gt;
+             &lt;div&gt;
+                 &lt;h1 className="text-3xl font-bold text-white flex items-center gap-3"&gt;
+                     &lt;Tags className="w-8 h-8 text-blue-500" /&gt;
+                     Products Catalog
+                 &lt;/h1&gt;
+                 &lt;p className="text-gray-400 mt-1"&gt;Manage individual SKUs and link them to suppliers&lt;/p&gt;
+             &lt;/div&gt;
+             &lt;div className="flex gap-3 w-full md:w-auto"&gt;
+                 &lt;a 
+                     href="/admin/import"
+                     className="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors whitespace-nowrap border border-gray-700"
+                 &gt;
+                     &lt;Upload className="w-4 h-4" /&gt;
+                     Import
+                 &lt;/a&gt;
+                 &lt;button
+                     onClick={openNewModal}
+                     className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors whitespace-nowrap shadow-lg shadow-blue-900/20"
+                 &gt;
+                     &lt;Plus className="w-4 h-4" /&gt;
+                     Add Product
+                 &lt;/button&gt;
+             &lt;/div&gt;
+         &lt;/div&gt;
+ 
+         {/* Toolbar: Search &amp; Filters */}
+         &lt;div className="bg-gray-900/50 p-4 rounded-xl border border-gray-800 flex flex-col lg:flex-row gap-4 items-center"&gt;
+             &lt;div className="relative flex-1 w-full"&gt;
+                 &lt;Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500" /&gt;
+                 &lt;input 
+                     placeholder="Search products by name, SKU, or supplier..." 
+                     className="w-full bg-gray-950 border border-gray-800 rounded-lg pl-10 pr-4 py-2.5 text-white focus:ring-2 focus:ring-blue-500/50 outline-none transition-all"
+                     value={searchTerm}
+                     onChange={(e) =&gt; setSearchTerm(e.target.value)}
+                 /&gt;
+             &lt;/div&gt;
+             
+             &lt;div className="flex gap-3 w-full lg:w-auto overflow-x-auto pb-2 lg:pb-0"&gt;
+                 &lt;div className="min-w-[160px]"&gt;
+                     &lt;SelectInput value={filterCategory} onChange={(e) =&gt; setFilterCategory(e.target.value)} className="w-full !py-2.5 !bg-gray-950"&gt;
+                         &lt;option value=""&gt;All Categories&lt;/option&gt;
+                         {rootCategories.map(c =&gt; &lt;option key={c.id} value={c.id}&gt;{c.name}&lt;/option&gt;)}
+                     &lt;/SelectInput&gt;
+                 &lt;/div&gt;
+                 
+                 &lt;div className="min-w-[160px]"&gt;
+                     &lt;SelectInput value={filterSupplier} onChange={(e) =&gt; setFilterSupplier(e.target.value)} className="w-full !py-2.5 !bg-gray-950"&gt;
+                         &lt;option value=""&gt;All Suppliers&lt;/option&gt;
+                         {suppliers.map(s =&gt; &lt;option key={s.id} value={s.id}&gt;{s.name}&lt;/option&gt;)}
+                     &lt;/SelectInput&gt;
+                 &lt;/div&gt;
+ 
+                 &lt;div className="min-w-[140px]"&gt;
+                     &lt;SelectInput value={filterPriceRange} onChange={(e) =&gt; setFilterPriceRange(e.target.value)} className="w-full !py-2.5 !bg-gray-950"&gt;
+                         &lt;option value=""&gt;Any Price&lt;/option&gt;
+                         &lt;option value="0-50"&gt;Under $50&lt;/option&gt;
+                         &lt;option value="50-100"&gt;$50 - $100&lt;/option&gt;
+                         &lt;option value="100-500"&gt;$100 - $500&lt;/option&gt;
+                         &lt;option value="500+"&gt;$500+&lt;/option&gt;
+                     &lt;/SelectInput&gt;
+                 &lt;/div&gt;
+             &lt;/div&gt;
+         &lt;/div&gt;
+       &lt;/div&gt;
+ 
+       {/* Product List (Grouped) */}
+       &lt;div className="space-y-8"&gt;
+         {Object.entries(groupedProducts).length === 0 ? (
+              &lt;div className="bg-gray-900 border border-gray-800 rounded-xl p-12 text-center text-gray-500"&gt;
+                 &lt;Package className="w-12 h-12 mx-auto mb-3 text-gray-700" /&gt;
+                 &lt;p&gt;No products found matching your criteria.&lt;/p&gt;
+             &lt;/div&gt;
+         ) : (
+             Object.values(groupedProducts).map(group =&gt; (
+                 &lt;div key={group.category.id} className="space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500"&gt;
+                     {/* Main Category Header */}
+                     &lt;div className="flex items-center gap-3 pb-2 border-b border-gray-800"&gt;
+                          &lt;h2 className="text-xl font-bold text-white flex items-center gap-2"&gt;
+                             &lt;Layers className="w-5 h-5 text-blue-500" /&gt;
+                             {group.category.name}
+                          &lt;/h2&gt;
+                          &lt;span className="text-xs font-mono text-gray-500 bg-gray-900 px-2 py-1 rounded-full border border-gray-800"&gt;
+                              {Object.values(group.subGroups).reduce((acc, g) =&gt; acc + g.products.length, 0)} items
+                          &lt;/span&gt;
+                     &lt;/div&gt;
+ 
+                     {/* Subgroups */}
+                     &lt;div className="grid gap-6"&gt;
+                         {Object.values(group.subGroups).map(subGroup =&gt; (
+                             &lt;div key={subGroup.subCategory?.id || 'root'} className="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden shadow-sm"&gt;
+                                 {/* Subcategory Header (if exists) */}
+                                 {subGroup.subCategory &amp;&amp; (
+                                     &lt;div className="bg-gray-800/30 px-6 py-2 border-b border-gray-800 flex items-center gap-2"&gt;
+                                         &lt;ChevronRight className="w-4 h-4 text-gray-500" /&gt;
+                                         &lt;h3 className="font-medium text-gray-300 text-sm"&gt;{subGroup.subCategory.name}&lt;/h3&gt;
+                                     &lt;/div&gt;
+                                 )}
+                                 
+                                 {/* Products Table */}
+                                 &lt;table className="w-full text-left text-sm text-gray-400"&gt;
+                                     &lt;thead className="bg-gray-950/50 text-gray-400 text-xs uppercase font-medium border-b border-gray-800"&gt;
+                                         &lt;tr&gt;
+                                             &lt;th className="px-6 py-3 w-[40%] cursor-pointer hover:text-white group/th" onClick={() =&gt; handleSort('name')}&gt;
+                                                 &lt;div className="flex items-center gap-2"&gt;Product &lt;SortIcon field="name" /&gt;&lt;/div&gt;
+                                             &lt;/th&gt;
+                                             &lt;th className="px-6 py-3 cursor-pointer hover:text-white group/th" onClick={() =&gt; handleSort('supplier')}&gt;
+                                                  &lt;div className="flex items-center gap-2"&gt;Supplier &lt;SortIcon field="supplier" /&gt;&lt;/div&gt;
+                                             &lt;/th&gt;
+                                             &lt;th className="px-6 py-3 cursor-pointer hover:text-white group/th" onClick={() =&gt; handleSort('price')}&gt;
+                                                 &lt;div className="flex items-center gap-2"&gt;Price &lt;SortIcon field="price" /&gt;&lt;/div&gt;
+                                             &lt;/th&gt;
+                                             &lt;th className="px-6 py-3 text-right"&gt;Actions&lt;/th&gt;
+                                         &lt;/tr&gt;
+                                     &lt;/thead&gt;
+                                     &lt;tbody className="divide-y divide-gray-800"&gt;
+                                         {subGroup.products.map((product) =&gt; (
+                                             &lt;tr key={product.id} className="hover:bg-gray-800/50 transition-colors group"&gt;
+                                                 &lt;td className="px-6 py-3"&gt;
+                                                     &lt;div className="flex gap-4"&gt;
+                                                         {product.image_url &amp;&amp; (
+                                                             &lt;img src={product.image_url} alt="" className="w-10 h-10 rounded bg-gray-800 object-cover border border-gray-700" /&gt;
+                                                         )}
+                                                         &lt;div&gt;
+                                                             &lt;div className="font-medium text-white"&gt;{product.name}&lt;/div&gt;
+                                                             &lt;div className="text-[11px] text-gray-500 font-mono flex items-center gap-2 mt-0.5"&gt;
+                                                                 {product.sku || product.asin || 'No ID'}
+                                                                 &lt;span className="w-0.5 h-0.5 rounded-full bg-gray-600"&gt;&lt;/span&gt;
+                                                                 {product.master_item?.name}
+                                                             &lt;/div&gt;
+                                                         &lt;/div&gt;
+                                                     &lt;/div&gt;
+                                                 &lt;/td&gt;
+                                                 &lt;td className="px-6 py-3"&gt;
+                                                     &lt;div className="flex flex-col gap-0.5"&gt;
+                                                         &lt;div className="text-gray-300 text-xs"&gt;{product.supplier?.name || 'Unknown'}&lt;/div&gt;
+                                                         &lt;span className={&#96;inline-flex w-fit px-1.5 py-0.5 rounded text-[9px] font-bold tracking-wide uppercase ${
+                                                             product.type === 'DROP_SHIP' 
+                                                             ? 'text-purple-400' 
+                                                             : 'text-blue-400'
+                                                         }&#96;}&gt;
+                                                             {product.type}
+                                                         &lt;/span&gt;
+                                                     &lt;/div&gt;
+                                                 &lt;/td&gt;
+                                                 &lt;td className="px-6 py-3"&gt;
+                                                     &lt;div className="text-white font-mono"&gt;${product.price?.toFixed(2)}&lt;/div&gt;
+                                                 &lt;/td&gt;
+                                                 &lt;td className="px-6 py-3 text-right"&gt;
+                                                     &lt;div className="flex justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity"&gt;
+                                                         &lt;button 
+                                                             onClick={() =&gt; openEditModal(product)}
+                                                             className="text-gray-400 hover:text-white p-1.5 hover:bg-gray-800 rounded transition-colors"
+                                                         &gt;
+                                                             &lt;Pencil className="w-3.5 h-3.5" /&gt;
+                                                         &lt;/button&gt;
+                                                         &lt;form action={async () =&gt; {
+                                                             if(confirm('Delete this product?')) await deleteProduct(product.id);
+                                                         }}&gt;
+                                                             &lt;button className="text-gray-400 hover:text-red-400 p-1.5 hover:bg-red-500/10 rounded transition-colors"&gt;
+                                                                 &lt;Trash2 className="w-3.5 h-3.5" /&gt;
+                                                             &lt;/button&gt;
+                                                         &lt;/form&gt;
+                                                     &lt;/div&gt;
+                                                 &lt;/td&gt;
+                                             &lt;/tr&gt;
+                                         ))}
+                                     &lt;/tbody&gt;
+                                 &lt;/table&gt;
+                             &lt;/div&gt;
+                         ))}
+                     &lt;/div&gt;
+                 &lt;/div&gt;
+             ))
+         )}
+       &lt;/div&gt;
+ 
+       {/* Edit Product Modal (Redesigned) */}
+       {isModalOpen &amp;&amp; (
+         &lt;div className="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 z-50"&gt;
+           &lt;div className="bg-[#0f1117] border border-gray-800 rounded-2xl w-full max-w-6xl h-[90vh] shadow-2xl flex flex-col overflow-hidden"&gt;
+             
+             {/* Header */}
+             &lt;div className="px-8 py-6 border-b border-gray-800 flex justify-between items-center bg-[#13161c]"&gt;
+                 &lt;div&gt;
+                     &lt;h2 className="text-xl font-bold text-white flex items-center gap-3"&gt;
+                         {editingProduct ? &lt;Pencil className="w-5 h-5 text-blue-500" /&gt; : &lt;Plus className="w-5 h-5 text-blue-500" /&gt;}
+                         {editingProduct ? 'Edit Product' : 'New Product'}
+                     &lt;/h2&gt;
+                     &lt;p className="text-gray-500 text-sm mt-1"&gt;Configure product details, pricing, and inventory settings.&lt;/p&gt;
+                 &lt;/div&gt;
+                 &lt;button onClick={() =&gt; setIsModalOpen(false)} className="text-gray-500 hover:text-white p-2 hover:bg-gray-800 rounded-lg transition-colors"&gt;
+                     &lt;X className="w-6 h-6" /&gt;
+                 &lt;/button&gt;
+             &lt;/div&gt;
+ 
+             {/* Scrollable Form Content */}
+             &lt;div className="flex-1 overflow-y-auto"&gt;
+                 &lt;form id="product-form" action={async (formData) =&gt; {
+                     if (editingProduct) {
+                         formData.append('id', editingProduct.id);
+                         await updateProduct(formData);
+                     } else {
+                         await createProduct(formData);
+                     }
+                     setIsModalOpen(false);
+                     setEditingProduct(null);
+                 }}&gt;
+                     &lt;div className="grid grid-cols-12 gap-0 min-h-full"&gt;
+                         
+                         {/* LEFT COLUMN: Main Content (Width 8/12) */}
+                         &lt;div className="col-span-12 lg:col-span-8 p-8 border-r border-gray-800 space-y-8"&gt;
+                             
+                             {/* Identity Section */}
+                             &lt;section&gt;
+                                 &lt;SectionTitle icon={Package}&gt;Product Identity&lt;/SectionTitle&gt;
+                                 &lt;InputGroup label="Product Name" required&gt;
+                                     &lt;TextInput name="name" defaultValue={editingProduct?.name} placeholder="e.g. Sawyer Squeeze Water Filter" required /&gt;
+                                 &lt;/InputGroup&gt;
+                                 &lt;InputGroup label="Description"&gt;
+                                     &lt;TextArea name="description" defaultValue={editingProduct?.description} placeholder="Detailed product description, features, and specs..." /&gt;
+                                 &lt;/InputGroup&gt;
+                             &lt;/section&gt;
+ 
+                             {/* Categorization Section */}
+                             &lt;section&gt;
+                                 &lt;SectionTitle icon={Layers}&gt;Categorization&lt;/SectionTitle&gt;
+                                 &lt;div className="grid grid-cols-1 md:grid-cols-3 gap-4 bg-gray-900/30 p-4 rounded-xl border border-gray-800/50"&gt;
+                                     &lt;InputGroup label="1. Category"&gt;
+                                         &lt;SelectInput 
+                                             value={selectedCategory} 
+                                             onChange={e =&gt; {
+                                                 setSelectedCategory(e.target.value);
+                                                 setSelectedSubCategory(""); // Reset subcat
+                                             }}
+                                         &gt;
+                                             &lt;option value=""&gt;Select Category...&lt;/option&gt;
+                                             {rootCategories.map(c =&gt; &lt;option key={c.id} value={c.id}&gt;{c.name}&lt;/option&gt;)}
+                                         &lt;/SelectInput&gt;
+                                     &lt;/InputGroup&gt;
+                                     
+                                     &lt;InputGroup label="2. Subcategory"&gt;
+                                         &lt;SelectInput 
+                                             value={selectedSubCategory}
+                                             onChange={e =&gt; setSelectedSubCategory(e.target.value)}
+                                             disabled={!selectedCategory || subCategories.length === 0}
+                                         &gt;
+                                             &lt;option value=""&gt;{subCategories.length === 0 ? 'No Subcategories' : 'Select Subcategory...'}&lt;/option&gt;
+                                             {subCategories.map(c =&gt; &lt;option key={c.id} value={c.id}&gt;{c.name}&lt;/option&gt;)}
+                                         &lt;/SelectInput&gt;
+                                     &lt;/InputGroup&gt;
+ 
+                                     &lt;InputGroup label="3. Master Item (Type)" required&gt;
+                                         &lt;div className="flex gap-2"&gt;
+                                             &lt;SelectInput 
+                                                 name="master_item_id" 
+                                                 defaultValue={editingProduct?.master_item_id} 
+                                                 required
+                                                 disabled={!selectedCategory}
+                                                 key={editingProduct?.master_item_id /* Force re-render when updating */}
+                                             &gt;
+                                                 &lt;option value=""&gt;
+                                                     {(!selectedCategory) ? 'Select Category First' : 
+                                                      (filteredMasterItems.length === 0 ? 'No Master Items Found' : 'Select Master Item...')}
+                                                 &lt;/option&gt;
+                                                 {filteredMasterItems.map(m =&gt; {
+                                                     let label = m.name;
+                                                     // If showing items from parent category (no subcategory selected), indicate subcategory
+                                                     if (!selectedSubCategory &amp;&amp; selectedCategory &amp;&amp; m.category_id !== selectedCategory) {
+                                                         const sub = categories.find(c =&gt; c.id === m.category_id);
+                                                         if (sub) label = &#96;${m.name} (${sub.name})&#96;;
+                                                     }
+                                                     return &lt;option key={m.id} value={m.id}&gt;{label}&lt;/option&gt;;
+                                                 })}
+                                             &lt;/SelectInput&gt;
+                                             &lt;button 
+                                                 type="button"
+                                                 disabled={!selectedCategory}
+                                                 onClick={() =&gt; setIsMasterItemModalOpen(true)}
+                                                 className="bg-gray-800 hover:bg-gray-700 text-white px-3 rounded-lg border border-gray-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
+                                                 title="Add New Master Item"
+                                             &gt;
+                                                 &lt;Plus className="w-4 h-4" /&gt;
+                                             &lt;/button&gt;
+                                         &lt;/div&gt;
+                                     &lt;/InputGroup&gt;
+                                 &lt;/div&gt;
+                                 {filteredMasterItems.length === 0 &amp;&amp; selectedCategory &amp;&amp; (
+                                     &lt;div className="mt-3 flex items-center gap-2 text-xs text-yellow-500 bg-yellow-500/10 p-3 rounded-lg"&gt;
+                                         &lt;AlertCircle className="w-4 h-4" /&gt;
+                                         No master items found in this category. Please add a Master Item first or check the category selection.
+                                     &lt;/div&gt;
+                                 )}
+                             &lt;/section&gt;
+ 
+                             {/* Media Section */}
+                             &lt;section&gt;
+                                 &lt;SectionTitle icon={ImageIcon}&gt;Media &amp; Links&lt;/SectionTitle&gt;
+                                 &lt;div className="grid grid-cols-1 md:grid-cols-2 gap-6"&gt;
+                                     &lt;InputGroup label="Product Page URL" required&gt;
+                                         &lt;div className="flex gap-2"&gt;
+                                             &lt;TextInput name="product_url" type="url" defaultValue={editingProduct?.product_url} placeholder="https://amazon.com/..." required /&gt;
+                                             {editingProduct?.product_url &amp;&amp; (
+                                                 &lt;a href={editingProduct.product_url} target="_blank" className="p-2.5 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors"&gt;
+                                                     &lt;ExternalLink className="w-4 h-4 text-gray-400" /&gt;
+                                                 &lt;/a&gt;
+                                             )}
+                                         &lt;/div&gt;
+                                     &lt;/InputGroup&gt;
+                                     &lt;InputGroup label="Image URL"&gt;
+                                         &lt;TextInput name="image_url" type="url" defaultValue={editingProduct?.image_url} placeholder="https://..." /&gt;
+                                     &lt;/InputGroup&gt;
+                                 &lt;/div&gt;
+                                 {/* Image Preview */}
+                                 {(editingProduct?.image_url) &amp;&amp; (
+                                     &lt;div className="mt-4 w-32 h-32 bg-gray-900 rounded-lg border border-gray-800 flex items-center justify-center overflow-hidden relative group"&gt;
+                                         &lt;img src={editingProduct.image_url} alt="Preview" className="w-full h-full object-contain" /&gt;
+                                         &lt;div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity"&gt;
+                                             &lt;span className="text-xs text-white font-medium"&gt;Preview&lt;/span&gt;
+                                         &lt;/div&gt;
+                                     &lt;/div&gt;
+                                 )}
+                             &lt;/section&gt;
+                         &lt;/div&gt;
+ 
+                         {/* RIGHT COLUMN: Sidebar (Width 4/12) */}
+                         &lt;div className="col-span-12 lg:col-span-4 bg-[#13161c] p-8 space-y-8 h-full"&gt;
+                             
+                             {/* Pricing Card */}
+                             &lt;div className="bg-gray-900/50 p-6 rounded-xl border border-gray-800"&gt;
+                                 &lt;SectionTitle icon={DollarSign}&gt;Pricing &amp; Type&lt;/SectionTitle&gt;
+                                 &lt;div className="space-y-4"&gt;
+                                     &lt;InputGroup label="Price ($)" required&gt;
+                                         &lt;TextInput name="price" type="number" step="0.01" defaultValue={editingProduct?.price} className="text-lg font-mono" required /&gt;
+                                     &lt;/InputGroup&gt;
+                                     &lt;InputGroup label="Fulfillment Type"&gt;
+                                         &lt;SelectInput name="type" defaultValue={editingProduct?.type || "AFFILIATE"}&gt;
+                                             &lt;option value="AFFILIATE"&gt;Affiliate Link (Referral)&lt;/option&gt;
+                                             &lt;option value="DROP_SHIP"&gt;Drop-Ship (Direct Sale)&lt;/option&gt;
+                                         &lt;/SelectInput&gt;
+                                     &lt;/InputGroup&gt;
+                                 &lt;/div&gt;
+                             &lt;/div&gt;
+ 
+                             {/* Inventory Card */}
+                             &lt;div className="bg-gray-900/50 p-6 rounded-xl border border-gray-800"&gt;
+                                 &lt;SectionTitle icon={Package}&gt;Inventory &amp; Supplier&lt;/SectionTitle&gt;
+                                 &lt;div className="space-y-4"&gt;
+                                     &lt;InputGroup label="SKU / ASIN"&gt;
+                                         &lt;TextInput name="asin" defaultValue={editingProduct?.sku || editingProduct?.asin} placeholder="e.g. B005EHPVQW" /&gt;
+                                     &lt;/InputGroup&gt;
+                                     
+                                     &lt;InputGroup label="Supplier" required&gt;
+                                         &lt;div className="flex gap-2"&gt;
+                                             &lt;SelectInput 
+                                                 name="supplier_id" 
+                                                 defaultValue={editingProduct?.supplier_id}
+                                                 key={editingProduct?.supplier_id}
+                                                 required
+                                             &gt;
+                                                 &lt;option value=""&gt;Select Supplier...&lt;/option&gt;
+                                                 {suppliersList.map(s =&gt; (
+                                                     &lt;option key={s.id} value={s.id}&gt;{s.name}&lt;/option&gt;
+                                                 ))}
+                                             &lt;/SelectInput&gt;
+                                             &lt;button 
+                                                 type="button"
+                                                 onClick={() =&gt; setIsSupplierModalOpen(true)}
+                                                 className="bg-gray-800 hover:bg-gray-700 text-white px-3 rounded-lg border border-gray-700 transition-colors"
+                                                 title="Add New Supplier"
+                                             &gt;
+                                                 &lt;Plus className="w-4 h-4" /&gt;
+                                             &lt;/button&gt;
+                                         &lt;/div&gt;
+                                     &lt;/InputGroup&gt;
+                                 &lt;/div&gt;
+                             &lt;/div&gt;
+ 
+                             {/* Metadata Card */}
+                             &lt;div className="bg-gray-900/50 p-6 rounded-xl border border-gray-800"&gt;
+                                 &lt;SectionTitle icon={Tags}&gt;Attributes&lt;/SectionTitle&gt;
+                                 &lt;div className="space-y-3"&gt;
+                                     &lt;InputGroup label="Brand"&gt;
+                                         &lt;TextInput name="meta_brand" defaultValue={editingProduct?.metadata?.brand} placeholder="Brand Name" /&gt;
+                                     &lt;/InputGroup&gt;
+                                     &lt;div className="grid grid-cols-2 gap-3"&gt;
+                                         &lt;InputGroup label="Weight (g)"&gt;
+                                             &lt;TextInput name="meta_weight_g" type="number" defaultValue={editingProduct?.metadata?.weight_g} /&gt;
+                                         &lt;/InputGroup&gt;
+                                         &lt;InputGroup label="Color"&gt;
+                                             &lt;TextInput name="meta_color" defaultValue={editingProduct?.metadata?.color} /&gt;
+                                         &lt;/InputGroup&gt;
+                                     &lt;/div&gt;
+                                 &lt;/div&gt;
+                             &lt;/div&gt;
+ 
+                         &lt;/div&gt;
+                     &lt;/div&gt;
+                 &lt;/form&gt;
+             &lt;/div&gt;
+ 
+             {/* Footer Actions */}
+             &lt;div className="px-8 py-4 border-t border-gray-800 bg-[#13161c] flex justify-between items-center"&gt;
+                 &lt;button type="button" onClick={() =&gt; { setIsModalOpen(false); setEditingProduct(null); }} className="px-6 py-2.5 text-gray-400 hover:text-white font-medium transition-colors"&gt;
+                     Cancel
+                 &lt;/button&gt;
+                 &lt;button 
+                     type="submit" 
+                     form="product-form"
+                     className="bg-blue-600 hover:bg-blue-500 text-white px-8 py-2.5 rounded-lg font-medium shadow-lg shadow-blue-900/20 flex items-center gap-2 transition-all hover:scale-105 active:scale-95"
+                 &gt;
+                     &lt;Save className="w-4 h-4" /&gt;
+                     {editingProduct ? 'Save Changes' : 'Create Product'}
+                 &lt;/button&gt;
+             &lt;/div&gt;
+ 
+           &lt;/div&gt;
+         &lt;/div&gt;
+       )}
+ 
+       {/* New Supplier Modal - kept simple */}
+       {isSupplierModalOpen &amp;&amp; (
+         &lt;div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-[60]"&gt;
+             &lt;div className="bg-gray-900 border border-gray-800 rounded-2xl p-6 w-full max-w-md shadow-xl animate-in fade-in zoom-in-95"&gt;
+                 &lt;h2 className="text-xl font-bold text-white mb-4"&gt;Create New Supplier&lt;/h2&gt;
+                 &lt;form action={async (formData) =&gt; {
+                     try {
+                         const newSupplier = await createSupplier(formData);
+                         if (newSupplier) {
+                             setSuppliersList(prev =&gt; [...prev, newSupplier].sort((a, b) =&gt; a.name.localeCompare(b.name)));
+                             // Auto-select the new supplier
+                             setEditingProduct((prev: any) =&gt; ({ ...prev, supplier_id: newSupplier.id }));
+                         }
+                         setIsSupplierModalOpen(false);
+                     } catch (e) {
+                         console.error(e);
+                         alert("Failed to create supplier");
+                     }
+                 }} className="space-y-4"&gt;
+                     &lt;InputGroup label="Name" required&gt;
+                         &lt;TextInput name="name" required /&gt;
+                     &lt;/InputGroup&gt;
+                     &lt;InputGroup label="Website URL"&gt;
+                         &lt;TextInput name="website_url" type="url" /&gt;
+                     &lt;/InputGroup&gt;
+                      &lt;InputGroup label="Fulfillment Type"&gt;
+                         &lt;SelectInput name="fulfillment_type"&gt;
+                             &lt;option value="AFFILIATE"&gt;Affiliate Partner&lt;/option&gt;
+                             &lt;option value="DROP_SHIP"&gt;Drop-Ship Vendor&lt;/option&gt;
+                         &lt;/SelectInput&gt;
+                     &lt;/InputGroup&gt;
+                     &lt;InputGroup label="Contact Email"&gt;
+                         &lt;TextInput name="contact_email" type="email" /&gt;
+                     &lt;/InputGroup&gt;
+                     &lt;div className="flex justify-end gap-3 pt-4"&gt;
+                         &lt;button type="button" onClick={() =&gt; setIsSupplierModalOpen(false)} className="px-4 py-2 text-gray-400 hover:text-white"&gt;Cancel&lt;/button&gt;
+                         &lt;button type="submit" className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-medium"&gt;
+                             Create Supplier
+                         &lt;/button&gt;
+                     &lt;/div&gt;
+                 &lt;/form&gt;
+             &lt;/div&gt;
+         &lt;/div&gt;
+       )}
+ 
+       {/* New Master Item Modal */}
+       {isMasterItemModalOpen &amp;&amp; (
+         &lt;div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-[60]"&gt;
+             &lt;div className="bg-gray-900 border border-gray-800 rounded-2xl p-6 w-full max-w-md shadow-xl animate-in fade-in zoom-in-95"&gt;
+                 &lt;h2 className="text-xl font-bold text-white mb-1"&gt;Create New Master Item&lt;/h2&gt;
+                 &lt;p className="text-gray-400 text-sm mb-4"&gt;
+                     Adding to: &lt;span className="text-blue-400 font-mono"&gt;{
+                         categories.find(c =&gt; c.id === (selectedSubCategory || selectedCategory))?.name || 'Unknown Category'
+                     }&lt;/span&gt;
+                 &lt;/p&gt;
+ 
+                 &lt;form action={async (formData) =&gt; {
+                     try {
+                         const category_id = selectedSubCategory || selectedCategory;
+                         if (!category_id) throw new Error("No category selected");
+                         
+                         formData.append('category_id', category_id);
+                         const newItem = await createMasterItem(formData);
+                         
+                         if (newItem) {
+                             setAllMasterItems(prev =&gt; [...prev, newItem].sort((a, b) =&gt; a.name.localeCompare(b.name)));
+                             // Auto-select the new item by updating editingProduct
+                             setEditingProduct((prev: any) =&gt; ({ ...prev, master_item_id: newItem.id }));
+                         }
+                         setIsMasterItemModalOpen(false);
+                     } catch (e) {
+                         console.error(e);
+                         alert("Failed to create master item");
+                     }
+                 }} className="space-y-4"&gt;
+                     &lt;InputGroup label="Master Item Name" required&gt;
+                         &lt;TextInput name="name" placeholder="e.g. Ultralight Backpack" required autoFocus /&gt;
+                     &lt;/InputGroup&gt;
+                     &lt;InputGroup label="Description"&gt;
+                         &lt;TextArea name="description" placeholder="General description of this type of item..." style={{ minHeight: '80px' }} /&gt;
+                     &lt;/InputGroup&gt;
+                     
+                     &lt;div className="flex justify-end gap-3 pt-4"&gt;
+                         &lt;button type="button" onClick={() =&gt; setIsMasterItemModalOpen(false)} className="px-4 py-2 text-gray-400 hover:text-white"&gt;Cancel&lt;/button&gt;
+                         &lt;button type="submit" className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-medium"&gt;
+                             Create Item
+                         &lt;/button&gt;
+                     &lt;/div&gt;
+                 &lt;/form&gt;
+             &lt;/div&gt;
+         &lt;/div&gt;
+       )}
+     &lt;/div&gt;
+   );
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 1 file</summary>
      
Lint paths:

- `src/app/admin/products/page.client.tsx`

Lint results

Lint errors for `src/app/admin/products/page.client.tsx`


| Message | Range | Severity |
|-------|-------|----------|
| Property 'master_item' does not exist on type 'Product'. Did you mean 'master_item_id'? | 427:74-427:85 | DIAGNOSTIC_SEVERITY_ERROR |
| 'Filter' is declared but its value is never read. | 4:177-4:183 | DIAGNOSTIC_SEVERITY_HINT |
| 'Supplier' is declared but never used. | 21:11-21:19 | DIAGNOSTIC_SEVERITY_HINT |


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/app/admin/products/page.client.tsx</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: src/app/admin/products/page.client.tsx</summary>

**Chunk 1**
Lines added: 2, lines removed: 2

```diff
@@ -225,6 +225,6 @@
      // Sorting
      result.sort((a, b) =&gt; {
-         let valA = a[sortField];
-         let valB = b[sortField];
+         let valA = a[sortField as keyof Product] as any;
+         let valB = b[sortField as keyof Product] as any;
  
          // Handle nested fields
```

**Chunk 2**
Lines added: 12, lines removed: 2

```diff
@@ -233,7 +233,17 @@
              valB = b.supplier?.name || '';
          }
+         // Special handling for master_item, we need to look it up if it's not directly on product
+         // Note: The product type doesn't have master_item object directly, but our action populates it via join?
+         // Checking the Product interface and getProducts action... getProducts DOES join master_items as 'master_item'
+         // But our Product interface defined in this file does NOT have master_item object property, just master_item_id
+         // Let's fix the Product interface to match reality or handle it here.
+         // Actually, looking at line 31 in actions.ts, it selects master_item:master_items(...)
+         // So the product object DOES have a master_item property at runtime.
+         
          if (sortField === 'master_item') {
-             valA = a.master_item?.name || '';
-             valB = b.master_item?.name || '';
+             const masterA = masterItems.find(m =&gt; m.id === a.master_item_id);
+             const masterB = masterItems.find(m =&gt; m.id === b.master_item_id);
+             valA = masterA?.name || '';
+             valB = masterB?.name || '';
          }
  
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: src/app/admin/products/page.client.tsx</summary>

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -37,4 +37,5 @@
      supplier_id: string;
      supplier?: { name: string };
+     master_item?: { name: string }; // Added to reflect data from join
      metadata?: any;
  }
```

</details>

</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 1 file</summary>
      
Lint paths:

- `src/app/admin/products/page.client.tsx`

Lint results

Lint errors for `src/app/admin/products/page.client.tsx`


| Message | Range | Severity |
|-------|-------|----------|
| 'Filter' is declared but its value is never read. | 4:177-4:183 | DIAGNOSTIC_SEVERITY_HINT |
| 'Supplier' is declared but never used. | 21:11-21:19 | DIAGNOSTIC_SEVERITY_HINT |


</details>
</tool-use>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Implement grouping of products by category and subcategory in the product list display.
- [x] Add filter controls for category, supplier, and price range to the product list toolbar.
- [x] Implement sorting logic with up/down triangle indicators for relevant columns.

</details>
</tool-use>

---

I have revamped the `/admin/products` page with advanced organization and filtering capabilities.

**What's New:**

1.  **Smart Grouping**: Products are now visually grouped by their **Category** and then by **Subcategory**. This makes it much easier to scan your catalog structure at a glance.
2.  **New Filter Toolbar**:
    *   **Category Filter**: Quickly narrow down the list to a specific category (and its subcategories).
    *   **Supplier Filter**: View products from a single supplier.
    *   **Price Filter**: Filter by price ranges (e.g., Under $50, $100+).
3.  **Sortable Columns**: You can now click the column headers (Product, Supplier, Price) to sort the list. Small up/down arrow icons indicate the current sort direction.
4.  **Refined UI**: The layout has been updated to accommodate these new controls while keeping the interface clean and usable.

The implementation handles filtering and sorting entirely on the client side for instant feedback. I also updated the TypeScript interfaces to correctly reflect the data structure, ensuring everything is type-safe.

---

